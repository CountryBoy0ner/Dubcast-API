<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dubcast Radio</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<header>
    <a href="/">Dubcast</a>

    <div>
        <a href="/login">Login</a>
        <a href="/register">Register</a>
        <a href="/profile">Profile</a>
    </div>
</header>

<main>
    <h1>Online radio</h1>

    <section style="margin-top: 20px;">
        <h2>Now playing</h2>

        <!-- Обложка -->
        <div>
            <img id="artwork"
                 src=""
                 alt="Artwork"
                 style="max-width: 200px; display: none;">
        </div>

        <!-- Название трека -->
        <p id="track-title">Now playing: nothing right now.</p>

        <!-- Кнопка старт радиостанции -->
        <button id="start-radio-btn" style="margin-top: 10px;">
            Start radio
        </button>

        <!-- Громкость -->
        <div style="margin-top: 10px;">
            <label for="volume-range">Volume:</label>
            <input type="range" id="volume-range" min="0" max="100" step="1">
        </div>

        <!-- Debug: показывать / скрывать реальный плеер -->
        <div style="margin-top: 10px;">
            <label>
                <input type="checkbox" id="show-player-checkbox" checked>
                Show SoundCloud player (debug)
            </label>
        </div>

        <!-- Контейнер, куда будет вставляться embed-код плейлиста -->
        <div id="sc-player-wrapper" style="margin-top: 10px;">
            <!-- сюда js подставит playlistEmbedCode -->
        </div>
    </section>
</main>



<!-- SockJS + STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<!-- SoundCloud Widget API -->
<script src="https://w.soundcloud.com/player/api.js"></script>

<script>
    // ----------- STATE -----------

    let stompClient = null;
    let radioStarted = false;      // пользователь нажал Start radio?
    let currentPayload = null;     // NowPlayingResponse
    let scWidget = null;           // SC.Widget одного трека
    let userVolume = 70;

    const artworkEl = document.getElementById('artwork');
    const titleEl = document.getElementById('track-title');
    const volumeEl = document.getElementById('volume-range');
    const startBtn = document.getElementById('start-radio-btn');
    const showPlayerCheckbox = document.getElementById('show-player-checkbox');
    const playerWrapper = document.getElementById('sc-player-wrapper');

    // ----------- INIT VOLUME -----------

    (function initVolume() {
        const saved = localStorage.getItem('dubcast_volume');
        userVolume = saved != null ? parseInt(saved, 10) : 70;
        if (isNaN(userVolume)) userVolume = 70;
        volumeEl.value = userVolume;
        console.log('[VOL] initial =', userVolume);
    })();

    volumeEl.addEventListener('input', function () {
        userVolume = parseInt(this.value, 10);
        localStorage.setItem('dubcast_volume', String(userVolume));
        console.log('[VOL] change ->', userVolume);
        if (scWidget) {
            scWidget.setVolume(userVolume);
        }
    });

    // ----------- SHOW / HIDE IFRAME (debug) -----------

    showPlayerCheckbox.addEventListener('change', function () {
        playerWrapper.style.display = this.checked ? 'block' : 'none';
    });

    // ----------- UI UPDATE -----------

    function updateUiFromPayload(payload) {
        console.log('[UI] update', payload);

        if (!payload || !payload.playing) {
            artworkEl.style.display = 'none';
            titleEl.innerText = 'Now playing: nothing right now.';
            return;
        }

        if (payload.artworkUrl) {
            artworkEl.src = payload.artworkUrl;
            artworkEl.style.display = 'block';
        } else {
            artworkEl.style.display = 'none';
        }

        titleEl.innerText = 'Now playing: ' + (payload.title || 'unknown track');
    }

    // ----------- HELPERS -----------

    function computeTrackPositionMs(payload) {
        if (!payload || !payload.startedAt || !payload.durationSeconds) {
            return 0;
        }
        const startedAtMs = Date.parse(payload.startedAt);
        if (Number.isNaN(startedAtMs)) {
            return 0;
        }
        const nowMs = Date.now();
        let elapsedSec = Math.max(0, (nowMs - startedAtMs) / 1000);
        if (elapsedSec > payload.durationSeconds - 1) {
            elapsedSec = payload.durationSeconds - 1;
        }
        const pos = Math.floor(elapsedSec * 1000);
        console.log('[POS] =', pos, 'ms from', payload.startedAt);
        return pos;
    }

    // ----------- WIDGET SETUP -----------

    function ensureWidgetIframe() {
        if (scWidget) {
            return;
        }

        // Заглушка: любой публичный трек, чтобы инициализировать iframe.
        // Потом мы всегда будем делать widget.load(payload.trackUrl)
        const placeholderTrack = 'https://soundcloud.com/ppjrecordings/ontology-maximum-ruffness-krave-remix';

        const src = 'https://w.soundcloud.com/player'
            + '?visual=true'
            + '&url=' + encodeURIComponent(placeholderTrack)
            + '&auto_play=false';

        playerWrapper.innerHTML = `
            <iframe
                id="sc-widget"
                width="100%"
                height="450"
                scrolling="no"
                frameborder="no"
                allow="autoplay"
                src="${src}">
            </iframe>
        `;

        const iframe = document.getElementById('sc-widget');
        scWidget = SC.Widget(iframe);
        console.log('[SC] widget created with placeholder');

        scWidget.bind(SC.Widget.Events.READY, function () {
            console.log('[SC] READY event');
        });

        scWidget.bind(SC.Widget.Events.ERROR, function (e) {
            console.error('[SC] ERROR event', e);
        });
    }

    // Загрузить конкретный трек по URL и перейти на нужную позицию
    function loadAndPlayFromPayload(payload) {
        if (!payload || !payload.playing) {
            console.log('[Radio] loadAndPlay: nothing playing in payload');
            return;
        }
        if (!payload.trackUrl) {
            console.error('[Radio] payload.trackUrl is missing');
            return;
        }

        ensureWidgetIframe();
        if (!scWidget) {
            console.error('[Radio] scWidget is null even after ensureWidgetIframe()');
            return;
        }

        const url = payload.trackUrl;
        const posMs = computeTrackPositionMs(payload);

        console.log('[Radio] widget.load(url, auto_play=true) url =', url, 'posMs =', posMs);

        scWidget.load(url, {
            auto_play: true,
            visual: true,
            callback: function () {
                console.log('[SC] load() callback, seekTo', posMs, 'ms, setVolume', userVolume);
                scWidget.setVolume(userVolume);
                if (posMs > 0) {
                    scWidget.seekTo(posMs);
                }
            }
        });
    }

    // ----------- REST: /api/radio/now -----------

    async function fetchCurrentForUiOnly() {
        try {
            console.log('[REST] GET /api/radio/now for UI');
            const resp = await fetch('/api/radio/now');
            if (resp.status === 204) {
                console.log('[REST] 204 No Content');
                currentPayload = null;
                updateUiFromPayload(null);
                return;
            }
            if (!resp.ok) {
                console.error('[REST] /api/radio/now error', resp.status);
                return;
            }
            const payload = await resp.json();
            console.log('[REST] initial payload', payload);
            currentPayload = payload;
            updateUiFromPayload(payload);   // только UI, звук не трогаем
        } catch (e) {
            console.error('[REST] current-for-ui error', e);
        }
    }

    // ----------- START RADIO BUTTON -----------

    startBtn.addEventListener('click', async function () {
        if (radioStarted) return;

        radioStarted = true;
        startBtn.disabled = true;
        startBtn.innerText = 'Radio is playing';

        console.log('[Radio] Start button clicked');

        try {
            if (!currentPayload) {
                console.log('[Radio] no currentPayload, fetch now');
                const resp = await fetch('/api/radio/now');
                if (resp.status === 204 || !resp.ok) {
                    console.log('[REST] no current track on start, status =', resp.status);
                    return;
                }
                currentPayload = await resp.json();
            }

            updateUiFromPayload(currentPayload);
            loadAndPlayFromPayload(currentPayload); // ВАЖНО: это внутри клика, браузер это считает жестом пользователя
        } catch (e) {
            console.error('[Radio] start-radio exception', e);
        }
    });

    // ----------- WS / STOMP -----------

    function connectWs() {
        console.log('[WS] Opening Web Socket...');
        const socket = new SockJS('/radio-ws');
        stompClient = Stomp.over(socket);
        // stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            console.log('[WS] connected:', frame);

            stompClient.subscribe('/topic/now-playing', function (message) {
                const payload = JSON.parse(message.body);
                console.log('[WS] now-playing payload', payload);
                handleNowPlaying(payload);
            });
        }, function (error) {
            console.error('[WS] error', error);
        });
    }

    function handleNowPlaying(payload) {
        console.log('[WS] handleNowPlaying', payload);
        currentPayload = payload;
        updateUiFromPayload(payload);

        if (!radioStarted) {
            console.log('[Radio] not started yet, just update UI');
            return;
        }
        if (!payload.playing) {
            console.log('[Radio] payload says nothing playing');
            return;
        }

        // Новый трек по расписанию → грузим его
        loadAndPlayFromPayload(payload);
    }

    // ----------- STARTUP -----------

    window.addEventListener('load', () => {
        console.log('[BOOT] Page loaded, init WS + fetch current');
        connectWs();
        fetchCurrentForUiOnly();
    });
</script>


</body>
</html>
