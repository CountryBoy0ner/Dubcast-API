databaseChangeLog:
  - changeSet:
      id: fix-schedule-overlap-trigger-ignore-self
      author: dubcast
      changes:
        - sql:
            splitStatements: false
            stripComments: false
            sql: |
              CREATE OR REPLACE FUNCTION no_schedule_overlap()
              RETURNS trigger AS $func$
              BEGIN
                  IF EXISTS (
                      SELECT 1
                      FROM schedule_entries e
                      WHERE e.id <> NEW.id
                        AND tstzrange(e.start_time, e.end_time)
                            && tstzrange(NEW.start_time, NEW.end_time)
                  ) THEN
                      RAISE EXCEPTION 'Schedule overlaps another entry';
                  END IF;
                  RETURN NEW;
              END;
              $func$ LANGUAGE plpgsql;
